package saucenao;

import okhttp3.*;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.MockedConstruction;

import java.io.File;
import java.io.IOException;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

class SauceNaoTest {
    private SauceNao sauceNao;
    private ResponseBody body;
    private Response response;
    private Call call;

    @BeforeEach
    void setUp() {
        sauceNao = spy(new SauceNao.SauceNaoBuilder()
                .apiKey("key")
                .build());
        body = mock(ResponseBody.class);
        response = mock(Response.class);
        call = mock(Call.class);
    }

    @Test
    void getSource() throws IOException, SauceNaoException {
        File file = mock(File.class);
        String string = "{\"header\":{\"user_id\":\"100332\",\"account_type\":\"1\",\"short_limit\":\"4\",\"long_limit\":\"100\",\"long_remaining\":95,\"short_remaining\":3,\"status\":0,\"results_requested\":16,\"index\":{\"0\":{\"status\":0,\"parent_id\":0,\"id\":0,\"results\":1},\"2\":{\"status\":0,\"parent_id\":2,\"id\":2,\"results\":1},\"5\":{\"status\":0,\"parent_id\":5,\"id\":5,\"results\":1},\"51\":{\"status\":0,\"parent_id\":5,\"id\":51,\"results\":1},\"52\":{\"status\":0,\"parent_id\":5,\"id\":52,\"results\":1},\"53\":{\"status\":0,\"parent_id\":5,\"id\":53,\"results\":1},\"6\":{\"status\":0,\"parent_id\":6,\"id\":6,\"results\":1},\"8\":{\"status\":0,\"parent_id\":8,\"id\":8,\"results\":1},\"9\":{\"status\":0,\"parent_id\":9,\"id\":9,\"results\":8},\"10\":{\"status\":0,\"parent_id\":10,\"id\":10,\"results\":1},\"11\":{\"status\":0,\"parent_id\":11,\"id\":11,\"results\":1},\"12\":{\"status\":0,\"parent_id\":9,\"id\":12,\"results\":8},\"16\":{\"status\":0,\"parent_id\":16,\"id\":16,\"results\":1},\"18\":{\"status\":0,\"parent_id\":18,\"id\":18,\"results\":1},\"19\":{\"status\":0,\"parent_id\":19,\"id\":19,\"results\":1},\"20\":{\"status\":0,\"parent_id\":20,\"id\":20,\"results\":1},\"21\":{\"status\":0,\"parent_id\":21,\"id\":21,\"results\":1},\"211\":{\"status\":0,\"parent_id\":21,\"id\":211,\"results\":1},\"22\":{\"status\":0,\"parent_id\":22,\"id\":22,\"results\":1},\"23\":{\"status\":0,\"parent_id\":23,\"id\":23,\"results\":1},\"24\":{\"status\":0,\"parent_id\":24,\"id\":24,\"results\":1},\"25\":{\"status\":0,\"parent_id\":9,\"id\":25,\"results\":8},\"26\":{\"status\":0,\"parent_id\":9,\"id\":26,\"results\":8},\"27\":{\"status\":0,\"parent_id\":9,\"id\":27,\"results\":8},\"28\":{\"status\":0,\"parent_id\":9,\"id\":28,\"results\":8},\"29\":{\"status\":0,\"parent_id\":9,\"id\":29,\"results\":8},\"30\":{\"status\":0,\"parent_id\":9,\"id\":30,\"results\":8},\"31\":{\"status\":0,\"parent_id\":31,\"id\":31,\"results\":1},\"32\":{\"status\":0,\"parent_id\":32,\"id\":32,\"results\":1},\"33\":{\"status\":0,\"parent_id\":33,\"id\":33,\"results\":1},\"34\":{\"status\":0,\"parent_id\":34,\"id\":34,\"results\":1},\"341\":{\"status\":0,\"parent_id\":341,\"id\":341,\"results\":1},\"35\":{\"status\":0,\"parent_id\":35,\"id\":35,\"results\":1},\"36\":{\"status\":0,\"parent_id\":36,\"id\":36,\"results\":1},\"37\":{\"status\":0,\"parent_id\":37,\"id\":37,\"results\":1},\"371\":{\"status\":0,\"parent_id\":371,\"id\":371,\"results\":1},\"38\":{\"status\":0,\"parent_id\":38,\"id\":38,\"results\":1},\"39\":{\"status\":0,\"parent_id\":39,\"id\":39,\"results\":1},\"40\":{\"status\":0,\"parent_id\":40,\"id\":40,\"results\":1},\"41\":{\"status\":0,\"parent_id\":41,\"id\":41,\"results\":1},\"42\":{\"status\":0,\"parent_id\":42,\"id\":42,\"results\":1},\"43\":{\"status\":0,\"parent_id\":43,\"id\":43,\"results\":1},\"44\":{\"status\":0,\"parent_id\":44,\"id\":44,\"results\":1}},\"search_depth\":\"128\",\"minimum_similarity\":16.119999999999997,\"query_image_display\":\"\\/userdata\\/JdTV7fxyH.gif.png\",\"query_image\":\"JdTV7fxyH.gif\",\"results_returned\":16},\"results\":[{\"header\":{\"similarity\":\"15.12\",\"thumbnail\":\"https:\\/\\/img1.saucenao.com\\/res\\/pixiv\\/5131\\/manga\\/51318798_p3.jpg?auth=-h-mo1V7CyNWJfAmutdquA\\u0026exp=1712689200\",\"index_id\":5,\"index_name\":\"Index #5: Pixiv Images - 51318798_p3.jpg\",\"dupes\":0,\"hidden\":0},\"data\":{\"ext_urls\":[\"https:\\/\\/www.pixiv.net\\/member_illust.php?mode=medium\\u0026illust_id=51318798\"],\"title\":\"\\u8840\\u754c\\u307e\\u3068\\u3081\\uff12\",\"pixiv_id\":51318798,\"member_name\":\"\\u7acb\\u6d6a\",\"member_id\":7996040}},{\"header\":{\"similarity\":\"15.02\",\"thumbnail\":\"https:\\/\\/img3.saucenao.com\\/kp\\/0b\\/bd\\/0bbd0e36f49af78bbb694cb94c2337b1866f0bbda01dc46e8c50a9080cbfd549.jpg.jpg?auth=FHF6UEheGJs5EUDH8abhng\\u0026exp=1712689200\",\"index_id\":43,\"index_name\":\"Index #43: Kemono - 0bbd0e36f49af78bbb694cb94c2337b1866f0bbda01dc46e8c50a9080cbfd549.jpg.jpg\",\"dupes\":0,\"hidden\":0},\"data\":{\"ext_urls\":[\"https:\\/\\/www.patreon.com\\/posts\\/48855170\",\"https:\\/\\/www.patreon.com\\/user?u=14792976\"],\"published\":\"2021-03-17T11:11:49.000Z\",\"title\":\"Wendy Blanco\",\"service\":\"patreon\",\"service_name\":\"Patreon\",\"id\":\"48855170\",\"user_id\":\"14792976\",\"user_name\":\"Etiennet\"}},{\"header\":{\"similarity\":\"14.95\",\"thumbnail\":\"https:\\/\\/img1.saucenao.com\\/res\\/2_hcg\\/Haramiko%20%5BSelen%5D%20%28587705%29\\/img\\/sys\\/Graphics\\/7cb5.jpg?auth=YNwBvSlTjCkGPF6bQJGHiQ\\u0026exp=1712689200\",\"index_id\":2,\"index_name\":\"Index #2: H-Game CG - 7cb5.jpg\",\"dupes\":0,\"hidden\":0},\"data\":{\"title\":\"Haramiko\",\"company\":\"Selen\",\"getchu_id\":\"587705\"}},{\"header\":{\"similarity\":\"14.41\",\"thumbnail\":\"https:\\/\\/img3.saucenao.com\\/ehentai\\/4f\\/23\\/4f23ec8c5e8ff0348bfeb3ece983f16fa335e0b5.jpg?auth=HmdlvEU3Cj3yL3wNh5xtZQ\\u0026exp=1712689200\",\"index_id\":38,\"index_name\":\"Index #38: H-Misc (E-Hentai) - 4f23ec8c5e8ff0348bfeb3ece983f16fa335e0b5.jpg\",\"dupes\":0,\"hidden\":0},\"data\":{\"source\":\"The Costume 2\",\"creator\":[\"vipcaptions\"],\"eng_name\":\"[VipCaptions] The Costume 2\",\"jp_name\":\"\"}},{\"header\":{\"similarity\":\"14.09\",\"thumbnail\":\"https:\\/\\/img1.saucenao.com\\/res\\/pixiv\\/7123\\/71231545_p0_master1200.jpg?auth=0r6WjOTwIA1qnSyo3jKDAg\\u0026exp=1712689200\",\"index_id\":5,\"index_name\":\"Index #5: Pixiv Images - 71231545_p0_master1200.jpg\",\"dupes\":0,\"hidden\":0},\"data\":{\"ext_urls\":[\"https:\\/\\/www.pixiv.net\\/member_illust.php?mode=medium\\u0026illust_id=71231545\"],\"title\":\"trans ?\",\"pixiv_id\":71231545,\"member_name\":\"motta705\",\"member_id\":15686493}},{\"header\":{\"similarity\":\"14.07\",\"thumbnail\":\"https:\\/\\/img1.saucenao.com\\/res\\/nijie\\/59\\/597437-63.jpg?auth=C9MzjdWOUQXs07kCN82cgQ\\u0026exp=1712689200\",\"index_id\":11,\"index_name\":\"Index #11: Nijie Images - 597437-63.jpg\",\"dupes\":0,\"hidden\":0},\"data\":{\"ext_urls\":[\"https:\\/\\/nijie.info\\/view.php?id=597437\"],\"title\":\"\\u3046\\u3061\\u306e\\u5b50\\u3000\\u5bfe\\u9762\\u30a8\\u30c3\\u30c1\",\"nijie_id\":597437,\"member_name\":\"\\u30d5\\u30eb\\u30e1\\u30ed\",\"member_id\":1543424}},{\"header\":{\"similarity\":\"13.98\",\"thumbnail\":\"https:\\/\\/img3.saucenao.com\\/skeb\\/91\\/91683-329024-calicchio23%2Bworks%2B79-2.jpg?auth=_P9B2ySjMZHiTF6HIhg7Gg\\u0026exp=1712689200\",\"index_id\":44,\"index_name\":\"Index #44: Skeb - 91683-329024-calicchio23+works+79-2.jpg\",\"dupes\":0,\"hidden\":0},\"data\":{\"ext_urls\":[\"https:\\/\\/skeb.jp\\/\\/@calicchio23\\/works\\/79\"],\"path\":\"\\/@calicchio23\\/works\\/79\",\"creator\":\"@calicchio23\",\"creator_name\":\"\\u7b39\\u5009\\u3055\\u3055\\u304f\\u3089\\ud83d\\udd1eSkeb\\u52df\\u96c6\\u4e2d\",\"author_name\":null,\"author_url\":\"https:\\/\\/skeb.jp\\/@calicchio23\"}},{\"header\":{\"similarity\":\"13.90\",\"thumbnail\":\"https:\\/\\/img1.saucenao.com\\/res\\/nhentai\\/248806%20%281295641%29%20--%20%5BNimu%5D%20Haitoku%20tte%20Kimochi%20Yokunai%21_%20%28COMIC%20Megastore%20Alpha%202017-01%29%20%5BChinese%5D%20%5BDigital%5D\\/33.jpg?auth=Fqc3pI4Jg-UwN3Cv3V5_PA\\u0026exp=1712689200\",\"index_id\":18,\"index_name\":\"Index #18: H-Misc (nhentai) - 33.jpg\",\"dupes\":0,\"hidden\":0},\"data\":{\"source\":\"Haitoku tte Kimochi Yokunai!_\",\"creator\":[\"nimu\"],\"eng_name\":\"[Nimu] Haitoku tte Kimochi Yokunai!_ (COMIC Megastore Alpha 2017-01)\",\"jp_name\":\"[\\u30cb\\u30e0] \\u80cc\\u5fb3\\u3063\\u3066\\u6c17\\u6301\\u3061\\u30e8\\u304f\\u306a\\u3043\\uff5e!? (\\u30b3\\u30df\\u30c3\\u30af\\u30e1\\u30ac\\u30b9\\u30c8\\u30a2\\u03b1 2017\\u5e741\\u6708\\u53f7)\"}},{\"header\":{\"similarity\":\"13.80\",\"thumbnail\":\"https:\\/\\/img3.saucenao.com\\/vpc\\/frame.php?expires=1712689200\\u0026auth=N0RSqIjyOSSaE11GjxUkBrZWpvc\\u0026rsz=0\\u0026enc=YW5pbWUvT25lIFBpZWNlL1tIb3JyaWJsZVN1YnNdIE9uZSBQaWVjZSAtIDI5OSBbNDgwcF0ubWt2LjcyNjUuemlw\\u0026sub=18690-41-779488.jpg\",\"index_id\":21,\"index_name\":\"Index #21: Anime* - 18690-41-779488.jpg (7265)\",\"dupes\":0,\"hidden\":0},\"data\":{\"ext_urls\":[\"https:\\/\\/anidb.net\\/anime\\/69\",\"https:\\/\\/myanimelist.net\\/anime\\/21\\/\",\"https:\\/\\/anilist.co\\/anime\\/21\\/\"],\"source\":\"One Piece\",\"anidb_aid\":69,\"mal_id\":21,\"anilist_id\":21,\"part\":\"299\",\"year\":\"1999\",\"est_time\":\"00:12:59 \\/ 00:23:20\"}},{\"header\":{\"similarity\":\"13.69\",\"thumbnail\":\"https:\\/\\/img1.saucenao.com\\/res\\/pixiv\\/600\\/6000819_s.jpg?auth=k1VZOUD6c7c7tkKCmg4U5A\\u0026exp=1712689200\",\"index_id\":5,\"index_name\":\"Index #5: Pixiv Images - 6000819_s.jpg\",\"dupes\":0,\"hidden\":0},\"data\":{\"ext_urls\":[\"https:\\/\\/www.pixiv.net\\/member_illust.php?mode=medium\\u0026illust_id=6000819\"],\"title\":\"\\u3010\\u7d20\\u6750\\u3011\\u7cf8\\u8272\\u671b\\u4ed5\\u69d8\\u77e2\\u7d63\\u30d1\\u30bf\\u30fc\\u30f3\",\"pixiv_id\":6000819,\"member_name\":\"\\u5922\\u5e7b\\u685c\\u82b1\",\"member_id\":897882}},{\"header\":{\"similarity\":\"13.39\",\"thumbnail\":\"https:\\/\\/img3.saucenao.com\\/dA2\\/87413\\/874130995.jpg?auth=FXR14iFKPDzI4_E0ACUH4w\\u0026exp=1712689200\",\"index_id\":34,\"index_name\":\"Index #34: deviantArt2 - 874130995.jpg\",\"dupes\":0,\"hidden\":0},\"data\":{\"ext_urls\":[\"https:\\/\\/deviantart.com\\/view\\/874130995\"],\"title\":\"Scorchers title\",\"da_id\":\"874130995\",\"author_name\":\"MaxwellFury\",\"author_url\":\"https:\\/\\/www.deviantart.com\\/maxwellfury\"}},{\"header\":{\"similarity\":\"12.87\",\"thumbnail\":\"https:\\/\\/img1.saucenao.com\\/res\\/pixiv_historical\\/1093\\/manga\\/10930775_p0.jpg?auth=em8AjzoX-tBBUuVnxKSogg\\u0026exp=1712689200\",\"index_id\":6,\"index_name\":\"Index #6: Pixiv Historical - 10930775_p0.jpg\",\"dupes\":0,\"hidden\":0},\"data\":{\"ext_urls\":[\"https:\\/\\/www.pixiv.net\\/member_illust.php?mode=medium\\u0026illust_id=10930775\"],\"title\":\"\\u72af\\u4eba\\u796d\\u308a\",\"pixiv_id\":10930775,\"member_name\":\"\\u3042\\u3093\\u3053\",\"member_id\":105245}},{\"header\":{\"similarity\":\"12.16\",\"thumbnail\":\"https:\\/\\/img3.saucenao.com\\/dA\\/20877\\/208770152.jpg?auth=io1IgU-coEd02mXRpoY7tw\\u0026exp=1712689200\",\"index_id\":34,\"index_name\":\"Index #34: deviantArt - 208770152.jpg\",\"dupes\":0,\"hidden\":0},\"data\":{\"ext_urls\":[\"https:\\/\\/deviantart.com\\/view\\/208770152\"],\"title\":\"dx\",\"da_id\":\"208770152\",\"author_name\":\"toghoj\",\"author_url\":\"http:\\/\\/toghoj.deviantart.com\"}},{\"header\":{\"similarity\":\"11.78\",\"thumbnail\":\"https:\\/\\/img3.saucenao.com\\/furaffinity\\/350\\/3507676.jpg?auth=6ROYorwu0ZDjLK7KLHLoCA\\u0026exp=1712689200\",\"index_id\":40,\"index_name\":\"Index #40: FurAffinity - 3507676.jpg\",\"dupes\":0,\"hidden\":0},\"data\":{\"ext_urls\":[\"https:\\/\\/www.furaffinity.net\\/view\\/3507676\"],\"title\":\"Powermad - Final Frontier beginning riff\",\"fa_id\":3507676,\"author_name\":\"tempesta\",\"author_url\":\"https:\\/\\/www.furaffinity.net\\/user\\/tempesta\"}},{\"header\":{\"similarity\":\"11.73\",\"thumbnail\":\"https:\\/\\/img3.saucenao.com\\/artstation\\/924\\/9248511_34484814.jpg?auth=E1u4RucAg30yX8OFtlJeug\\u0026exp=1712689200\",\"index_id\":39,\"index_name\":\"Index #39: Artstation - 9248511_34484814.jpg\",\"dupes\":0,\"hidden\":0},\"data\":{\"ext_urls\":[\"https:\\/\\/www.artstation.com\\/artwork\\/8eygBE\"],\"title\":\"Portrait painting 12\",\"as_project\":\"8eygBE\",\"author_name\":\"Jaiven Jaan\",\"author_url\":\"https:\\/\\/www.artstation.com\\/jaiven\"}},{\"header\":{\"similarity\":\"10.92\",\"thumbnail\":\"https:\\/\\/img3.saucenao.com\\/madokami\\/Manga\\/M\\/MA\\/MAOU\\/Maou%20Dante\\/Maou%20Dante%20v01.zip\\/080-081.jpg?auth=PBaMG-7uAaWZkKKDSmdETQ\\u0026exp=1712689200\",\"index_id\":36,\"index_name\":\"Index #36: Madokami (Manga) - 080-081.jpg\",\"dupes\":0,\"hidden\":0},\"data\":{\"ext_urls\":[\"https:\\/\\/www.mangaupdates.com\\/series.html?id=4451\"],\"mu_id\":4451,\"source\":\"Maou Dante\",\"part\":\"Maou Dante v01\",\"type\":\"Manga\"}}]}";
        when(body.string()).thenReturn(string);
        when(response.body()).thenReturn(body);
        when(call.execute()).thenReturn(response);
        MockedConstruction<OkHttpClient> mockClient = mockConstruction(OkHttpClient.class, (okHttpClient, context) -> {
            when(okHttpClient.newCall(any())).thenReturn(call);
        });
        SauceNaoRes sauceNaoRes = sauceNao.getSource(file);
        assertEquals("https://www.pixiv.net/member_illust.php?mode=medium&illust_id=51318798", sauceNaoRes.getBestResult());
    }

}